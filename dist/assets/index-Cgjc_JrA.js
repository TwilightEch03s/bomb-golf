import*as r from"https://esm.sh/three@0.181.2";import{OrbitControls as H}from"https://esm.sh/three@0.181.2/examples/jsm/controls/OrbitControls.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();let c,f,u,M,R,p;const E=[];let x;const F=-9.82;let L=null;const S=100,_=40,D=85;let l=0,w=!1,g=!1,b=null;function C(){console.log("Start function called"),V(),console.log("Scene initialized"),q(),console.log("Physics initialized"),X(),console.log("Bodies created"),U(),T(),console.log("Animation started")}function V(){c=new r.Scene,c.background=new r.Color(1710618),c.fog=new r.Fog(1710618,50,100);const e=globalThis.innerWidth,t=globalThis.innerHeight;f=new r.PerspectiveCamera(75,e/t,.1,1e3),f.position.set(0,10,20),f.lookAt(0,0,0),u=new r.WebGLRenderer({antialias:!0}),u.setSize(e,t),u.shadowMap.enabled=!0,u.shadowMap.type=r.PCFShadowMap,document.body.appendChild(u.domElement);const n=new r.AmbientLight(16777215,.5);c.add(n);const o=new r.DirectionalLight(16777215,1);o.position.set(20,20,20),o.castShadow=!0,o.shadow.mapSize.width=2048,o.shadow.mapSize.height=2048,o.shadow.camera.left=-50,o.shadow.camera.right=50,o.shadow.camera.top=50,o.shadow.camera.bottom=-50,c.add(o),M=new H(f,u.domElement),M.enableDamping=!0,M.dampingFactor=.05,R=new r.Clock,globalThis.addEventListener("resize",j)}function q(){const e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),n=new Ammo.btDbvtBroadphase,o=new Ammo.btSequentialImpulseConstraintSolver;p=new Ammo.btDiscreteDynamicsWorld(t,n,o,e),p.setGravity(new Ammo.btVector3(0,F,0)),x=new Ammo.btTransform}function X(){const o=new Ammo.btBoxShape(new Ammo.btVector3(20,1,20)),i=P(o,0,{x:0,y:0,z:0});c.remove(i.mesh);const a=new r.PlaneGeometry(40,40),s=new r.MeshStandardMaterial({color:3815994,side:r.DoubleSide}),m=new r.Mesh(a,s);m.rotation.x=-Math.PI/2,m.position.y=1,m.receiveShadow=!0,c.add(m);const A=new Ammo.btBoxShape(new Ammo.btVector3(1,1,1)),y=P(A,1,{x:0,y:2,z:6});y.mesh.material.color.set(8947848),c.add(y.mesh),L=y.rigidBody}function Y(){const e=new r.BoxGeometry(50,2,50),t=new r.MeshStandardMaterial({color:8947848}),n=new r.Mesh(e,t);n.position.y=-5,n.castShadow=!0,n.receiveShadow=!0,c.add(n);for(let o=0;o<5;o++){const i=new r.BoxGeometry(2,2,2),a=new r.MeshStandardMaterial({color:Math.random()*16777215,roughness:.7}),s=new r.Mesh(i,a);s.position.set(Math.random()*10-5,5+o*3,Math.random()*10-5),s.castShadow=!0,s.receiveShadow=!0,c.add(s)}}function B(){try{V(),console.log("Scene initialized without physics"),Y(),console.log("Simple bodies created"),T(),console.log("Animation started (no physics)")}catch(e){console.error("Failed to initialize scene:",e)}}function P(e,t,n){let o,i;try{if(e instanceof Ammo.btBoxShape){const d=e.getHalfExtentsWithMargin(),I=d.x?d.x():1,O=d.y?d.y():1,G=d.z?d.z():1;o=new r.BoxGeometry(I*2,O*2,G*2),i=new r.MeshStandardMaterial({color:Math.random()*16777215,roughness:.7})}else e instanceof Ammo.btSphereShape?(o=new r.SphereGeometry(1,32,32),i=new r.MeshStandardMaterial({color:Math.random()*16777215,roughness:.7})):(o=new r.BoxGeometry(2,2,2),i=new r.MeshStandardMaterial({color:8947848}))}catch{o=new r.BoxGeometry(2,2,2),i=new r.MeshStandardMaterial({color:8947848})}const a=new r.Mesh(o,i);a.castShadow=!0,a.receiveShadow=!0,a.position.set(n.x,n.y,n.z);const s=new Ammo.btTransform;s.setIdentity(),s.setOrigin(new Ammo.btVector3(n.x,n.y,n.z));const m=new Ammo.btDefaultMotionState(s),A=new Ammo.btVector3(0,0,0);if(t>0)try{e.calculateLocalInertia(t,A)}catch{}const y=new Ammo.btRigidBodyConstructionInfo(t,m,e,A),h=new Ammo.btRigidBody(y);if(t>0)try{h.setFriction(.6),h.setRestitution(.05),h.activate&&h.activate()}catch{}return p.addRigidBody(h),h.mesh=a,E.push(h),{mesh:a,rigidBody:h}}function T(){requestAnimationFrame(T);const e=R.getDelta();p&&(p.stepSimulation(e,10),E.forEach(t=>{const n=t.getMotionState();if(n){n.getWorldTransform(x);const o=x.getOrigin(),i=x.getRotation();t.mesh.position.set(o.x(),o.y(),o.z()),t.mesh.quaternion.set(i.x(),i.y(),i.z(),i.w())}})),w&&(l+=_*e,l>S&&(l=S),g=l>=D,v()),p&&E.forEach(t=>{try{const n=t.getLinearVelocity();if(n){const o=n.x(),i=n.y(),a=n.z();Math.sqrt(o*o+i*i+a*a)<.03&&(t.setLinearVelocity(new Ammo.btVector3(0,0,0)),t.setAngularVelocity(new Ammo.btVector3(0,0,0)))}}catch{}}),M.update(),u.render(c,f)}function j(){const e=globalThis.innerWidth,t=globalThis.innerHeight;f.aspect=e/t,f.updateProjectionMatrix(),u.setSize(e,t)}function Z(){const e=document.createElement("div");e.id="power-ui";const t=document.createElement("div");t.id="power-fill",e.appendChild(t);const n=document.createElement("div");n.id="power-label",n.textContent="Power",document.body.appendChild(e),document.body.appendChild(n),b=t,v()}function v(){if(!b)return;const e=Math.max(0,Math.min(1,l/S));b.style.height=`${e*100}%`,g?b.classList.add("power-over"):b.classList.remove("power-over")}function N(){w||(w=!0,l=0,g=!1,v())}function $(){if(w){if(w=!1,g=l>=D,L&&p){const e=new r.Vector3;f.getWorldDirection(e),e.y=0,e.lengthSq()<1e-5&&e.set(0,0,-1),e.normalize();const t=l/S*60;let n=0;g&&(n=Math.random()*2*(Math.random()<.5?-1:1));const o=new r.Vector3(-e.z,0,e.x).normalize(),i=e.x*t+o.x*n,a=e.z*t+o.z*n,s=.15*(l/S),m=new Ammo.btVector3(i,s,a);L.applyCentralImpulse(m)}setTimeout(()=>{l=0,g=!1,v()},120)}}function U(){document.getElementById("power-ui")||Z(),globalThis.addEventListener("keydown",e=>{e.code==="Space"&&(e.preventDefault(),w||N())}),globalThis.addEventListener("keyup",e=>{e.code==="Space"&&(e.preventDefault(),$())})}console.log("Main.ts loaded, waiting for Ammo...");let z=0;const k=100;function W(){const e=globalThis.Ammo;z++,console.log(`Attempt ${z}: Ammo=${typeof e}`),e&&(typeof e=="function"||typeof e=="object")?(console.log("Ammo found! Type:",typeof e),typeof e=="function"?(console.log("Ammo is a function, calling it..."),e().then(C).catch(t=>{console.error("Failed to initialize Ammo:",t),B()})):(console.log("Ammo is already an object, starting..."),C())):z<k?setTimeout(W,100):(console.error("Ammo.js failed to load after timeout"),B())}setTimeout(W,1e3);
